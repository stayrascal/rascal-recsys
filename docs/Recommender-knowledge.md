

### 大数据量下的推荐系统设计


#### 用户历史行为截断
大多数的推荐引擎都会使用到用户的历史行为数据，比如用户的点击、下单、购买、支付、收藏、退款、评价等行为。在实际使用的过程中如果使用所有积累的数据的话，在大数据量的情况下，无论是在时间还是空间上都不太现实，所以一般会根据用户历史行为距离当前的时间进行相应的时间筛选，筛选的目的是加强近期行为的权重，减少远久行为的权重。

实际应用中，会结合用户的活跃度和行为的类别来做相应的截断
- 活跃度： 较活跃的用户保留时间较短的行为，不太活跃的用户保留时间更长一些的行为，常用方式有两个：
    * 以一个时间段为界，保留这个时间段以内的数据，比如3个月、1年等
    * 以固定数量保留用户的行为，比如1000条，使用类似队列这种先进先出的数据结构
- 行为的类别
    * 频率：高频的行为保留时间短一些，低频行为保留时间长一些
    * 用户的意图强弱： 收藏、下单等行为可以保留的长一些，点击行为可以保留短一些
数据截断时，一般会考虑线上存储空间的占用和实际效果优化需求来折中考虑，选择性价比高的方案。

#### 用户数据的使用
- 用户行为数据
    * 用于候选集触发算法中的离线计算
    * 根据用户行为意图的强弱，在训练重排序模型时可以针对不用的行为设定不用的回归目标值
    * 可以作为重排序模型的交叉特征，用于离线训练和在线预测
- 用户画像数据
    * 在候选集触发过程中对Deal进行加权和降权
    * 作为重排序模型中的用户维度特征

#### 个性化推荐的成功应用的两个必要条件
- 信息过载
    * 如果用户可以很容易地从所有物品中找到喜欢的物品，就不需要个性化推荐了
- 没有特别明确的需求
    * 如果用户有明确的需求，可以直接通过搜索引擎找到感兴趣的物品
    
#### 候选集召回
- 基于协同过滤的召回
    * 如果想要获得很好的效果，往往需要根据具体的业务做一些差异化处理。清除作弊、刷单、代购等噪声数据
    * 同时选取的训练数据的时间窗口不宜过长，也不能过短
    * 还可以引入时间衰减，近期的用户行为能反映用户接下来的行为动作
- 基于位置的召回
    * 一般会根据用户的实时地理位置、工作地、居住地等地理位置触发相应的策略
    * 根据地理位置的粒度不同，可以分为附近召回、当前商圈召回、当前城市召回
    * 由于某些原因获取不到用户实时地理位置时，只能推荐用户所在城市，比如推荐该城市热门商圈或者旅游景点等信息
    * 根据地理位置，又可以分为两种情况：
        - 周围资源不太丰富，可以扩大限制的距离，或者扩大GeoHash的范围
        - 周围资源丰富，可以加强对距离的限制，并按照一定因素进行排序，比如热度、销量等，选出TopN的结果
- 基于搜索查询的召回
    * 对用户过去一段时间的搜索无转化行为进行挖掘，计算每一个用户对不同查询的权重
    * 计算每个查询下不用Item的权重。根据查询下Item的展现次数和点击次数计算权重
    * 用户再次请求时，根据用户对不用查询的权重以及查询下不用Item的权重进行加权，取出权重最大的TopN进行推荐
- 基于图的召回
    * 对于协同过滤而言，用户之间或者Item之间的图距离是两跳，无法考虑更远的距离
    * 图算法把用户和Item的关系视作一个二部图，相互的关系可以在图上传播
    * 可以使用Simrank对等实体相似度的图算法
- 基于事实用户行为的召回
    * 主要是根据用户实时浏览、实时收藏等行为数据将用户之前没有发生转化的Item再次推荐给用户
- 替补策略
    * 对于部分新用户或者历史行为不太丰富的用户
    * 热销单
    * 好评单
    * 城市单
    
#### 推荐排序
在选择排序的时候，需要考虑特征的覆盖率、区分度等因素，排序时主要用到下面几种特征：
- Item特征：主要是Item本身的一些属性，如价格，折扣，销量，评分，类别，历史点击率等
- 用户特征：包括用户偏好，用户等级，用户的人口属性，用户的客户端类型等
- 用户和Item的交叉特征：包括用户对Item的点击、收藏、购买等
- 距离特征：包括用户的实时地理位置，厂区地理位置，工作地，居住地等与POI的距离
- 场景特征：包括本地、异地，是否周末、节假日，天气因素等特征

在进行排序之前一般会进行一些特征处理
- 排序特征处理：非线性模型可以直接使用上述特征。而线性模型则需要对特征值做一些分桶、归一化等处理，是特征值成为0~1的连续值或者0/1二值
- 排序特征选择：尽量保留重要的特征，同时要考虑特征的覆盖率
- 排序特征监控：监控特征的有效性，包括均值、特征覆盖率等同比、环比指标。

排序样本处理
- 样本选择
    * 正例一般是用户产生点击、下单等转换行为的样本
    * 负例的样本一般不是直接选择没有转化的行为，因为很多展现用户根本都没有看到，把这样的样本视为负例不合理，也会影响模型的效果，一般常用的方法是Skip-Above，即用户点击的Item位置以上的展现的才可能作负例，，还可以使用用户主动删除的显式反馈数据
    * 曝光数据的应用： Skip-Above有一个问题就是在构建训练样本时，只保留了用户点击的Session的样本，没有点击的Session中的负样本都丢掉了。有用户点击的样本对应的用户往往偏活跃一些，这样会造成最终训练集合的分布会更偏向于那些有点击的活跃用户。要解决这个问题，可以使用实际给用户曝光的数据，比如在APP中埋点跟踪曝光的情况，对于那些实际给用户有曝光，但是用户没点击的样本，可以作为负样本补充到样本集合中
    * 对样本做去燥：针对数据中混杂的刷单类作弊行为数据，需要将其排除
    * 样本采样和样本权重
        - 正负样本严重不均衡，需要对负样本做采样
        - 不用行为对推荐结果的反馈程度不同，例如点击，下单，支付等式一个从弱到强的认可度，所以可以设置支付样本的权重 > 下单样本的权重 > 点击样本的权重
 
 排序模型
 - 非线性模型能很好的捕捉特征中的非线性关系，但是训练和预测代价相对线性模型要高一些，更新周期相对要长，主要采用非线性的树模型Additive Grove
 - 线性模型对特征的处理要求比较高，但是模型简单，训练和预测的效率较高，更新周期短,主要采用逻辑回归
 - 为了能实时捕捉数据分布的变化，可以使用在线学习，比如使用FTRL方法对模型进行在线更新
 
 #### 推荐评价指标
 - 信息维度：主要应用于信息类的推荐展位，例如新闻资讯推荐，视频推荐，广告
    * 点击率CTR
    * 设备点击数
    * 设备点击数用户数
    * 停留时间
    * 浏览深度
    * 阅读深度
    * 收藏数/收藏量/收藏率
    * 分享率
    * 点赞数
    * 好评率
- 交易维度：主要应用于交易维度的推荐展位，如电商推荐
    * 下单率CVR
    * 支付率
    * 设备购买数
    * 设备购买用户数
    * GMV交易额
    * 利润、利润率
- 体验维度：主要用于衡量推荐展位的用户体验效果
    * 不喜欢率
    * Bad Case比例
    * 新颖度
    * 多样性
    * 用户回访周期
    * 用户流失率